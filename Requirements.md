# ちよプラブックスペース 要件定義書

## 1. 概要

企業図書館向けの図書貸出ウェブサービス。Next.js App Router、Supabase（BaaS・ストレージ）、NextAuth（認証）で構築する。利用者・蔵書規模は小規模（利用者約50名、蔵書約300冊）を想定し、単一館・日本語のみで運用する。

---

## 2. 技術スタック

| 項目 | 技術 |
|------|------|
| フロント/バック | Next.js App Router |
| DB・ストレージ | Supabase（PostgreSQL + Storage） |
| 認証 | NextAuth（メール+パスワード）のみ。**Supabase Auth は利用しない**。ユーザー情報は Supabase のデータベース上のテーブルで管理する。 |
| 書誌データ取得 | 国会図書館API |

---

## 3. 利用者・役割

### 3.1 利用者タイプ

| 役割 | 説明 | 主な操作 |
|------|------|----------|
| **一般利用者** | 貸出・返却は受付でのみ（システム上では行わない） | 蔵書検索・閲覧、自分の会員証QR・貸出中書籍一覧の確認 |
| **司書・管理者** | 日常運用（受付者として貸出・返却操作を実行） | 上記に加え、蔵書登録・削除、利用者管理、棚卸、返却依頼メール送信、**貸出・返却の登録操作** |
| **システム管理者** | システム全体 | 上記全て＋システム設定・運用 |

### 3.2 認証

- **会員登録**: 必要。
- **認証方式**: メール + パスワードのみ。
- **会員証**: 利用者には会員証（QRコード）を発行する。貸出・返却時に受付で提示し、スキャンして利用者を特定する。
- **利用者無効化**: 管理者が利用者を無効化した場合、その利用者はログインできない。
- 未ログイン時は一切参照不可（検索・一覧含めログイン必須）。

### 3.3 会員証（QRコード）の生成・格納・表示

- **登録時の生成**: ユーザー登録を行った場合、そのユーザーの **ID** と **名前** を取得できるQRコードを生成し、**データに格納** する。
- **ユーザー情報画面での表示**: 利用者が自分の情報を確認する「ユーザー情報画面」では、格納した会員証（QRコード）を **表示** する。利用者はこの画面でQRコードを提示できる（画面表示をそのまま受付で見せる、または印刷して会員証として利用する想定）。
- **利用者ログイン後の表示**: 利用者がログインしたら、**自分のQRコード** と **現在貸出されている書籍の一覧** が表示される（トップ画面またはダッシュボードとして表示する）。

### 3.5 お気に入り（利用者向け）

- **概要**: 利用者は蔵書詳細画面で書籍を**お気に入り**に登録・解除できる。
- **表示**: 書籍詳細画面でお気に入り状態（星マーク）を表示し、トグルで登録・解除する。
- **用途**: 後から参照したい書籍のマーキングや、検索結果からの絞り込み補助を想定する。

### 3.4 管理者のみが可能な操作

- 蔵書の登録・削除
- 利用者管理（一覧・編集・**無効化**。無効化した利用者はログイン不可）
- 蔵書の棚卸
- **タグの管理**（タグマスタの追加・編集・削除、書籍編集画面でのタグ付与・解除）

---

## 4. 蔵書・カタログ

### 4.1 管理対象

- **書籍情報（書誌）**: タイトル、著者、出版社、ISBN およびその他メタデータ。
- **タグ**: 書籍に複数タグを付与可能。タグマスタは管理者が管理し、書籍編集画面でタグの付与・解除を行う。蔵書検索・詳細でタグを表示する。
- 同一書誌の複数所蔵（複本）の有無は要件上は未定義。必要に応じて「所蔵資料」単位の管理を検討可能。

### 4.2 書誌項目

| 項目 | 必須 | 備考 |
|------|------|------|
| タイトル | ○ | |
| 著者 | ○ | |
| ISBN | ○ | |
| 出版社 | ○ | |
| 表紙画像 | 任意 | 設定可能。Supabase Storage に保存。 |

その他（出版年・カテゴリ等）は実装時に必要に応じて追加可能。

### 4.3 検索

- **検索対象項目**: タイトル、著者、出版社、ISBN。
- **検索方式**: いずれも前後部分一致（あいまい検索）をサポート。

### 4.4 外部連携

- **国会図書館API** を利用し、書誌情報の取得・補完を行う。

---

## 5. 貸出・返却ルール

### 5.0 貸出・返却の操作権限

- **書籍の貸出・返却は受付者のみが行える。** 受付者（司書・管理者）がシステム上で貸出登録・返却登録を行う。
- **利用者はシステム上から貸出・返却の操作は行えない。** 利用者は受付に本と会員証を提示し、受付者が操作する運用とする。

### 5.1 貸出

- **貸出期間**: 固定の返却期限は設けない（「○日以内返却」等の制限なし）。
- **同時貸出冊数**: 1人あたり **1冊まで**。
- **延長**: 概念なし（貸出期間を定めないため）。

### 5.2 予約

- 貸出中であっても **予約は取らない**。

### 5.3 延滞・罰則

- 返却期限を定めないため、**延滞・罰則の概念はなし**。

### 5.4 貸出日数

- **貸出日数**（貸出開始日から何日経過しているか）を管理し、一覧・詳細などで **表示する**。
- 利用者・管理者ともに、どの程度の期間貸し出しているかを把握できるようにする。

### 5.5 貸出フロー（利用者が書籍を借りる際）

貸出は受付での対面操作で行う。手順は以下のとおりとする。

1. **利用者**: 借りたい本をシステム上で検索する。
2. **利用者**: 借りたい本を実際の本棚から取り出し、受付に持ってくる。
3. **利用者**: 自分の会員証（QRコード）を提示する。
4. **受付者（司書・管理者）**: 利用者が持ってきた本の **ISBN** を入力して本を特定し、続けて利用者の会員証を **スキャン** する。
5. **システム**: 入力された本のISBNと、スキャンされた会員証のQRコード（利用者特定用）をもとに **貸出登録** を行う。

- 利用者には **会員証（QRコード）** を発行し、貸出・返却時に受付で提示・スキャンする運用とする。
- 貸出操作は受付者が行うため、システムには「受付者用の貸出処理画面」（ISBN入力・会員証QRスキャン対応）を用意する。

### 5.6 返却フロー（利用者が書籍を返却する際）

返却も受付での対面操作で行う。手順は以下のとおりとする。

1. **利用者**: 返却したい本を受付に持ってくる。
2. **利用者**: 自分の会員証（QRコード）を提示する。
3. **受付者（司書・管理者）**: 利用者が持ってきた本の **ISBN** を入力して本を特定した後、利用者の会員証を **スキャン** する。
4. **システム**: 入力された本のISBNと、スキャンされた会員証のQRコード（利用者特定用）をもとに **返却登録** を行う。

- 返却操作も受付者が行うため、システムには「受付者用の返却処理画面」（ISBN入力・会員証QRスキャン対応）を用意する。貸出処理画面と同一または統合した画面でもよい。

### 5.7 貸出・返却履歴の管理・参照

- **利用者**: 自分の貸出・返却履歴を一覧で参照できる。貸出日・返却日（返却済みの場合）・書籍情報・貸出日数を表示する。
- **司書・管理者**: 全利用者の貸出・返却履歴を参照できる。現在貸出中一覧と過去の返却済み履歴を一覧表示し、必要に応じて利用者・書籍・状態（貸出中／返却済み）で絞り込めるようにする。
- 履歴データは既存の貸出テーブル（loans）で保持し、lent_at・returned_at により貸出中／返却済みを判別する。

---

## 6. 通知（メールのみ）

| トリガー | 内容 | 送信先 |
|----------|------|--------|
| 貸出時 | 貸出完了の通知 | 当該利用者 |
| 返却時 | 返却完了の通知 | 当該利用者 |
| 管理者操作 | 返却依頼 | 管理者が指定した利用者 |

- 通知手段は **メールのみ**（アプリ内通知は対象外）。
- 管理者は利用者に対して **返却依頼メール** を送信できる機能を持つ。
- **送信履歴**: メール送信のたびに **送信履歴を残す**。送信日時・宛先・種別（貸出通知・返却通知・返却依頼等）などを記録する。

---

## 7. ストレージ（Supabase Storage）

- **保存するデータ**:
  - 表紙画像
  - 書籍情報（DB に保存する書誌データ；ストレージは主に画像用と解釈）
- **アクセス制御**: すべてのコンテンツ（蔵書一覧・検索・詳細・画像含む）は **ログイン済みユーザーのみ** 参照可能。

---

## 8. 運用・スコープ

| 項目 | 内容 |
|------|------|
| 想定規模 | 企業図書館（利用者約50名、蔵書約300冊） |
| 館数 | 1館のみ |
| 言語 | 日本語のみ |
| 公開範囲 | インターネット経由で公開（認証後に利用） |

---

## 9. 非機能要件

| 項目 | 内容 |
|------|------|
| パフォーマンス | 特段の目標値は設けない |
| バックアップ | 要件としては必須としない。必要に応じてデータベースのバックアップを運用で実施する |
| 監査ログ | 要件としては必須としない（必要に応じて将来追加可能） |

---

## 10. まとめ（実装時に持つべき方針）

- **認証**: NextAuth でメール+パスワードのみとし、全画面でログイン必須とする。会員証（QRコード）は登録時に生成・格納し、利用者画面で表示する。利用者を無効化した場合はログイン不可とする。
- **利用者画面**: ログイン後は自分のQRコードと現在貸出中書籍一覧を表示。貸出・返却の操作は利用者にはさせず、受付者のみがシステム上で行う。蔵書詳細でお気に入り（星マーク）の登録・解除ができる。
- **蔵書**: タイトル・著者・ISBN・出版社を必須とし、表紙画像は Supabase Storage に保存。国会図書館API で書誌取得。タグを付与可能とし、管理者がタグマスタを管理する。
- **検索**: タイトル・著者・出版社・ISBN で前後部分一致検索。
- **貸出・返却**: 受付者のみが貸出登録・返却登録を実行。1人1冊まで、期間・延長・予約・延滞・罰則はなし。貸出日数は管理・表示する。
- **通知**: 貸出・返却時の利用者向けメール、および管理者による返却依頼メールを実装する。送信履歴はデータベースに保存する。
