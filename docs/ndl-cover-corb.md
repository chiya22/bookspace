# 国会図書館の表紙画像と CORB アラート

## 書影APIのURL形式（2024年1月変更）

国立国会図書館サーチのリニューアルに伴い、書影APIのURL形式が変更されました。

| 項目 | 旧形式（廃止） | 新形式（2024年1月〜） |
|------|----------------|------------------------|
| ドメイン | `iss.ndl.go.jp` | `ndlsearch.ndl.go.jp` |
| パス | `/thumbnail/{isbn}` | `/thumbnail/{isbn}.jpg` |
| 備考 | 拡張子なし | **末尾に `.jpg` が必須** |

参考: [書影API リクエスト方法](https://ndlsearch.ndl.go.jp/help/api/thumbnail)

---

## 現象

- 書籍一覧などで表紙画像を国会図書館の書影 API（`https://iss.ndl.go.jp/thumbnail/{isbn}`）から取得している
- ブラウザに **「Cross-Origin Read Blocking (CORB) blocked a cross-origin response」** が表示され、画像が表示されないことが多い

## 原因

### CORB とは

**Cross-Origin Read Blocking (CORB)** は、クロスオリジン（別ドメイン）のレスポンスを、リクエストした用途と異なる形で読み取るのをブロックするブラウザの仕組みです。

### なぜブロックされるか

1. **直接 `<img src="https://iss.ndl.go.jp/...">` で読み込んでいる**
   - ブラウザが **あなたのアプリのオリジン** から **国会図書館 (iss.ndl.go.jp)** へ画像を取得しに行く（クロスオリジン）

2. **国会図書館側の応答**
   - 書影がある場合は画像（Content-Type: image/jpeg など）を返す
   - **書影がない場合やエラー時は HTML のエラーページ（Content-Type: text/html）を返す**ことがある

3. **CORB の判定**
   - `<img>` は「画像」としての読み込みのため、レスポンスは画像であることが期待される
   - 実際に **HTML（テキスト）** が返ると、「画像として使おうとしているのに中身が HTML」と判断され、**クロスオリジンのそのレスポンスはブロック**される
   - その結果、コンソールに CORB のメッセージが出て、画像が表示されない

4. **その他の要因**
   - 国会図書館サーバーが **Cross-Origin-Resource-Policy** 等で埋め込みを制限している場合も、クロスオリジンでの利用がブロックされやすい

まとめると、「**別オリジンの URL をそのまま img で参照していること**」と「**404/エラー時に HTML が返ること**」が重なって、CORB によりブロックされています。

## 対処方法

### 方針: プロキシ経由で配信する

**ブラウザからは国会図書館に直接アクセスさせず、自前の API を経由して画像を配信する**ようにします。

1. ブラウザの `<img src="...">` は **同一オリジン** の URL だけを参照する  
   - 例: `https://あなたのアプリ/api/cover/ndl?isbn=9784123456789`
2. その API（Next.js の API Route など）の**サーバー側**で、国会図書館の URL に **サーバーから** fetch する
3. サーバー同士の通信では CORS/CORB はかからないので、画像が取れたらそのバイト列をそのままレスポンスで返す
4. ブラウザは「自分のドメインの API から画像をもらった」と解釈するため、CORB に引っかからない

このように「**表紙表示用の URL は自サイトのプロキシ URL に統一する**」実装にすると、CORB アラートは解消し、画像が取得できない場合も「表紙なし」などで安定して扱えます。

### 実装上のポイント

- **表示用の表紙 URL**  
  - 国会図書館の URL をそのまま返すのではなく、  
    `getNdlThumbnailUrl(isbn)` などで **プロキシ用のパス**（例: `/api/cover/ndl?isbn=...`）を返す
- **プロキシ API**  
  - `GET /api/cover/ndl?isbn=...` で、サーバーが `https://iss.ndl.go.jp/thumbnail/{isbn}` を fetch  
  - 成功時: 画像の Content-Type を付けて body をそのまま返す  
  - 失敗・404・HTML が返った時: 404 などを返し、フロントでは「表紙なし」表示にする
- **書籍登録時の書影取得**  
  - サーバーから国会図書館へ fetch して Storage に保存する処理は、これまでどおり**直接 NDL の URL** で問題ありません（サーバー間なので CORB は関係しない）

この構成にすることで、CORB アラートを出さずに、国会図書館の書影を表紙表示に利用できます。
