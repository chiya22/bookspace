# 動作確認手順

開発環境でアプリの動作を確認する手順。**追加のパッケージは不要**です。既存の `npm install` 済みの依存関係だけで確認できます。

---

## 前提条件

- **Node.js**: 18.x 以上（推奨: 20.x）
- **Supabase**: プロジェクト作成済み、マイグレーション実行済み（`users`, `books`, `loans`, `email_logs` テーブルがあること）
- **環境変数**: プロジェクトルートに `.env.local` があり、次の値が設定されていること

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=...（32文字以上のランダム文字列）
```

Supabase の初期設定がまだの場合は [Supabase セットアップ手順](./supabase-setup.md) を先に実施してください。

---

## 1. 依存関係のインストール（初回または package.json 変更後）

```bash
npm install
```

※ フェーズ1・2で必要なパッケージは既に `package.json` に入っています。追加インストールは不要です。

---

## 2. 開発サーバーの起動

```bash
npm run dev
```

- ブラウザで **http://localhost:3000** を開く。
- 未ログインのため **http://localhost:3000/login** にリダイレクトされ、ログイン画面が表示されれば OK。

---

## 3. 会員登録の確認

1. ログイン画面の **「会員登録」** リンクをクリックする（または http://localhost:3000/register を開く）。
2. 次の内容で入力する：
   - **メール**: 任意のメールアドレス（例: `test@example.com`）
   - **パスワード**: 8文字以上（例: `password123`）
   - **名前**: 任意（例: `テストユーザー`）
3. **「登録する」** をクリックする。
4. **「会員登録が完了しました。ログインしてください。」** と表示され、ログイン画面（`/login?registered=1`）に遷移すれば OK。

---

## 4. ログインの確認

1. 先ほど登録した **メール** と **パスワード** を入力する。
2. **「ログイン」** をクリックする。
3. **トップ画面（`/`）** に遷移し、次の内容が表示されれば OK：
   - **会員証（QRコード）**: 画像が表示される
   - **現在貸出中の書籍**: 「現在貸出中の書籍はありません。」（初回は空）

---

## 5. トップ・アカウント画面の確認

- **トップ（`/`）**: 会員証QR と 貸出中一覧 が表示されていること。
- ヘッダーの **「アカウント」** をクリック → **名前・メール・会員証QR** が表示されること。
- ヘッダーの **「蔵書検索」** をクリック → 「フェーズ3で実装予定」のプレースホルダーが表示されること。

---

## 6. ログアウトの確認

1. ヘッダー右の **「ログアウト」** をクリックする。
2. ログイン画面（`/login`）に戻ること。
3. ブラウザで http://localhost:3000 を開くと、再びログイン画面にリダイレクトされること。

---

## 7. 一般利用者での受付・管理画面の制限確認

1. 上記で登録した **一般利用者**（role: `user`）でログインする。
2. ブラウザで直接次のURLを開く：
   - http://localhost:3000/reception/loan
   - http://localhost:3000/admin
3. いずれも **トップ（`/`）にリダイレクト**され、受付・管理画面が表示されないこと。

---

## 8. 司書・管理者としての確認（任意）

司書または管理者としてログインし、受付・管理メニューにアクセスできることを確認する。

1. **Supabase ダッシュボード** を開く。
2. **Table Editor** で **`users`** テーブルを開く。
3. 確認用に登録したユーザーの **`role`** を `user` から **`librarian`** に変更し保存する。
4. アプリで一度 **ログアウト** し、同じメール・パスワードで **再ログイン** する。
5. ヘッダーに **「受付・貸出」** と **「管理」** のリンクが表示されること。
6. **「受付・貸出」** → 貸出処理のプレースホルダー画面が表示されること。
7. **「管理」** → 管理メニュー（蔵書管理・利用者管理・棚卸のリンク）が表示されること。

確認後、必要に応じて Supabase で `role` を `user` に戻してよい。

---

## よくあるトラブル

| 現象 | 確認すること |
|------|----------------|
| ログインできない | メール・パスワードが正しいか。Supabase の `users` テーブルに該当レコードがあるか。 |
| QRコードが表示されない | 会員登録直後は `qr_code_data` が入っている。Supabase の `users` で該当ユーザーの `qr_code_data` に JSON 文字列が入っているか確認。 |
| リダイレクトループ | `NEXTAUTH_URL` が `http://localhost:3000` になっているか。`NEXTAUTH_SECRET` が設定されているか。 |
| ビルドエラー | `npm run build` でエラーになる場合、`npm run lint` も実行して確認。 |

---

## コマンド一覧

| コマンド | 説明 |
|----------|------|
| `npm install` | 依存関係のインストール（初回や package.json 変更後） |
| `npm run dev` | 開発サーバー起動（http://localhost:3000） |
| `npm run build` | 本番用ビルドの確認 |
| `npm run lint` | ESLint の実行 |
