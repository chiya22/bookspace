# 貸出・返却履歴管理 — 必要となる修正一覧

貸出・返却の履歴を管理するために必要な要件の追記・ドキュメント更新・実装をすべてリストアップしたもの。

---

## 1. 要件定義（Requirements.md）の修正

### 1.1 追記する要件

**場所**: セクション 5（貸出・返却ルール）の末尾、または新規「5.7 貸出・返却履歴」として追加。

| 項目 | 内容 |
|------|------|
| **利用者の履歴参照** | 利用者は **自分の** 貸出・返却履歴を参照できる。過去に借りた書籍一覧、貸出日・返却日・貸出日数などを確認できるようにする。 |
| **司書・管理者の履歴参照** | 司書・管理者は **全利用者** の貸出・返却履歴を参照できる。現在貸出中一覧・返却済み履歴の一覧表示、必要に応じて利用者・書籍・期間でフィルタできるようにする。 |
| **履歴に含める情報** | 書籍（タイトル・著者・ISBN）、利用者（名前・メール）、貸出日時（lent_at）、返却日時（returned_at）、貸出日数（経過日数または貸出〜返却の日数）。 |

### 1.2 修正例（Requirements.md に追加する文言）

```markdown
### 5.7 貸出・返却履歴の管理・参照

- **利用者**: 自分の貸出・返却履歴を一覧で参照できる。貸出日・返却日（返却済みの場合）・書籍情報・貸出日数を表示する。
- **司書・管理者**: 全利用者の貸出・返却履歴を参照できる。現在貸出中一覧と過去の返却済み履歴を一覧表示し、必要に応じて利用者・書籍・状態（貸出中／返却済み）で絞り込めるようにする。
- 履歴データは既存の貸出テーブル（loans）で保持し、lent_at・returned_at により貸出中／返却済みを判別する。
```

---

## 2. データモデル・ドキュメント（docs/data-model.md）の修正

### 2.1 修正内容

| 箇所 | 内容 |
|------|------|
| **loans の説明** | 「貸出履歴の参照」で利用する旨を追記。返却済み（returned_at 設定済み）も含めて履歴として参照する。 |
| **インデックス** | 既存の `idx_loans_user_id`, `idx_loans_returned_at`, `idx_loans_book_id` で履歴一覧・フィルタは対応可能。必要なら `lent_at` の降順検索用インデックスを追記（任意）。 |

### 2.2 スキーマ変更

- **不要**。既存の `loans` テーブル（user_id, book_id, lent_at, returned_at）で履歴は賄える。

---

## 3. 画面一覧（docs/screens.md）の修正

### 3.1 利用者向け

| パス（案） | 画面名 | 説明 | アクセス |
|------------|--------|------|----------|
| `/loans` または `/account/loans` | 貸出履歴（自分の） | 自分の貸出・返却履歴一覧。貸出中・返却済みを表示。貸出日・返却日・書籍・貸出日数。 | 一般, 司書, sys |

### 3.2 受付・管理者向け

| パス（案） | 画面名 | 説明 | アクセス |
|------------|--------|------|----------|
| `/reception/loans` または `/admin/loans` | 貸出履歴一覧 | 全利用者の貸出・返却履歴。現在貸出中／返却済みのタブまたはフィルタ。利用者名・書籍・貸出日・返却日。 | 司書, sys |

- 既存の「貸出処理」「返却処理」はそのまま。履歴画面は別ルートとして追加。

---

## 4. 実装タスク一覧

### 4.1 バックエンド・クエリ

| No | タスク | 内容 |
|----|--------|------|
| H1 | 自分の貸出履歴取得 | `lib/loans/queries.ts`（または既存の適切な場所）に、`getLoansByUserId(userId)` を追加。loans を user_id で絞り、books・users は join または別取得。lent_at 降順。 |
| H2 | 全貸出履歴取得（管理者用） | `getAllLoans(options?)` を追加。状態フィルタ（貸出中のみ / 返却済みのみ / すべて）、ソート（lent_at 降順など）、必要ならページネーション。books・users の情報を結合して返す。 |

### 4.2 利用者向け画面

| No | タスク | 内容 |
|----|--------|------|
| H3 | 自分の貸出履歴ページ | `app/(main)/loans/page.tsx`（または `app/(main)/account/loans/page.tsx`）。getSession で userId を取得し、getLoansByUserId で一覧取得。テーブルまたはカードで「書籍・貸出日・返却日・貸出日数」を表示。貸出中は返却日「—」、返却済みは返却日と貸出日数を表示。 |
| H4 | ナビへのリンク追加 | MainNav に「貸出履歴」リンクを追加（`/loans` など）。全ログイン利用者が表示。 |

### 4.3 受付・管理者向け画面

| No | タスク | 内容 |
|----|--------|------|
| H5 | 貸出履歴一覧ページ | `app/(main)/reception/loans/page.tsx`（または `app/(main)/admin/loans/page.tsx`）。getAllLoans で一覧取得。テーブル表示で「利用者名・書籍・貸出日・返却日・状態（貸出中/返却済み）」を表示。状態でフィルタ（タブまたはセレクト）。 |
| H6 | 受付ナビへのリンク追加 | MainNav または受付レイアウトに「貸出履歴」リンクを追加（`/reception/loans` など）。司書・管理者のみ表示。 |

### 4.4 共通コンポーネント（任意）

| No | タスク | 内容 |
|----|--------|------|
| H7 | 貸出履歴テーブルコンポーネント | 利用者用・管理者用で表示項目が異なるため、共通化する場合は「履歴1行」用のコンポーネントや「履歴テーブル」コンポーネントを作成。必須ではない。 |

---

## 5. タスク進捗管理（docs/task-progress.md）の修正

### 5.1 フェーズ4 へのタスク追加

| No | タスク | 状態 | 優先度 | フェーズ | 備考 |
|----|--------|------|--------|---------|------|
| 4.7 | 利用者の貸出・返却履歴画面（自分の履歴） | 未着手 | 高 | 4 | /loans。getLoansByUserId、貸出日・返却日・貸出日数表示 |
| 4.8 | 司書・管理者の貸出・返却履歴一覧（全件） | 未着手 | 高 | 4 | /reception/loans。getAllLoans、貸出中/返却済みフィルタ |

### 5.2 進捗サマリの更新

- フェーズ4 の「合計」を 6 → 8 に変更。
- 4.7・4.8 完了時に「完了」数を +2 し、計の完了数も更新。

---

## 6. まとめチェックリスト

| # | 種別 | 項目 |
|---|------|------|
| 1 | 要件 | Requirements.md に「5.7 貸出・返却履歴の管理・参照」を追加 |
| 2 | ドキュメント | data-model.md に loans の履歴利用の記載を追加（任意） |
| 3 | ドキュメント | screens.md に「自分の貸出履歴」「管理者用貸出履歴一覧」を追加 |
| 4 | 実装 | lib/loans/queries.ts（または同様）に getLoansByUserId を実装 |
| 5 | 実装 | 上記に getAllLoans（管理者用）を実装 |
| 6 | 実装 | 利用者用「自分の貸出履歴」ページを実装 |
| 7 | 実装 | 受付・管理者用「貸出履歴一覧」ページを実装 |
| 8 | 実装 | MainNav に「貸出履歴」リンクを追加（利用者・受付それぞれ） |
| 9 | タスク管理 | task-progress.md に 4.7・4.8 を追加し、進捗サマリを更新 |

以上で、要件定義から実装・タスク管理まで一通り揃う。
